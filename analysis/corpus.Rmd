---
title: "Usage metrics"
output:
    html_document:
        gallery: false
        toc: true
        toc_depth: 3
        toc_float: true
        df_print: paged
editor_options: 
  chunk_output_type: console
params:
  base_dir: Data/
---

```{r setup, include=FALSE}
local(for (x in c(
  "dplyr", 
  "DT",
  "fs",
  "fst",
  "ggplot2",
  "ggthemes",
  "lubridate",
  "readr",
  "purrr",
  "stringr",
  "tidyr",
  "viridis"
  )) {
  suppressPackageStartupMessages(library(x, character.only=TRUE))
})

knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  fig.retina = 2,
  fig.width = 10
)

source("inc/functions.R")
source("inc/latextags.R")
source("inc/paths.R")

create_tags(path(TAGS_DIR, "corpus.tex"), prefix = "", default = TRUE)
theme_set(theme_minimal())
```

## Load data

```{r load corpus}
CRAN_eval_traces <- 
  read_fst(PACKAGE_SUM_CALLS_FILE) %>%
  # remove evals that are inside the scripts,
  # for CRAN we are only interested in evals in packages
  filter(!str_starts(eval_call_srcref, "::global::main")) %>% 
  as_tibble()

CRAN_eval_traces_per_package <- 
  count(CRAN_eval_traces, caller_package, eval_call_srcref) %>%
  count(caller_package) %>% 
  rename(package=caller_package, evals_hit=n)

ALL_CRAN <- 
  read_fst(CORPUS_ALL_FILE) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  mutate(evals=as.integer(evals)) %>% 
  filter(loadable, package_code > 0) %>% 
  as_tibble()

CRAN <- 
  read_fst(CORPUS_FILE) %>%
  filter(package_code > 0) %>%
  left_join(CRAN_eval_traces_per_package, by="package") %>% 
  mutate_if(is.numeric, replace_na, 0) %>%
  mutate(
    evals=as.integer(evals),
    evals_hit=as.integer(evals_hit),
    # this is the case when there is eval in package loading code
    # this we will always run
    evals_hit=if_else(evals_hit > evals, evals, evals_hit),
    evals_coverage=evals_hit/evals
  ) %>% 
  as_tibble()

ALL_CRAN_eval_callsites <- 
  read_csv(PACKAGE_EVALS_STATIC_FILE) %>% 
  # TODO: There are very few NA, plus when srcref is NA, the rest of the row in NA
  # we should look at this
  filter(!is.na(srcref))

CRAN_eval_callsites <- semi_join(ALL_CRAN_eval_callsites, CRAN, by="package")

ALL_KAGGLE <- local({
  kernels <- read_csv(KAGGLE_KERNEL_FILE)
  evals <- read_csv(KAGGLE_EVALS_STATIC_FILE) %>% count(package) %>% rename(evals=n)
  left_join(kernels, evals, by="package") 
}) %>%
  mutate_if(is.numeric, replace_na, 0) %>% 
  mutate(evals=as.integer(evals)) %>% 
  as_tibble()

KAGGLE <- filter(ALL_KAGGLE, evals > 0)
```

## Overview

```{r}
cran_all_funs <- sum(ALL_CRAN$funs_public) + sum(ALL_CRAN$funs_private)
cran_funs <- sum(CRAN$funs_public) + sum(CRAN$funs_private)
cran_funs_with_eval <- sum(CRAN$funs_with_eval)
cran_code <- sum(CRAN$package_code)
cran_all_code <- sum(ALL_CRAN$package_code)
cran_evals <- CRAN$evals
cran_evals_hit <- CRAN$evals_hit

overview_table(
  r("CRAN all packages", ALL_CRAN),
  r("CRAN packages", CRAN),
  r("CRAN packages ratio", ratio(CRAN, ALL_CRAN)),
  r("CRAN all code", cran_all_code),
  r("CRAN all r code", sum(ALL_CRAN$package_r_code)),
  r("CRAN all native code", sum(ALL_CRAN$package_native_code)),
  r("CRAN code", cran_code),
  r("CRAN code ratio", ratio(cran_code, cran_all_code)),
  r("CRAN all funs", cran_all_funs),
  r("CRAN funs", cran_funs),
  r("CRAN funs with eval", cran_funs_with_eval),
  r("CRAN funs with eval ratio", ratio(cran_funs_with_eval, cran_funs)),
  r("CRAN all funs with eval ratio", ratio(cran_funs_with_eval, cran_all_funs)),
  r("CRAN eval call sites", sum(cran_evals)),
  r("CRAN hit eval call sites", sum(cran_evals_hit)),
  r("CRAN hit eval call sites avg ratio", percent(mean(cran_evals_hit/cran_evals))),
  r("CRAN runnable scripts", sum(ALL_CRAN$runnable_files)),
  r("CRAN runnable code", sum(ALL_CRAN$runnable_code)),
  r("CRAN runnable code examples", sum(ALL_CRAN$runnable_code_examples)),
  r("CRAN runnable code tests", sum(ALL_CRAN$runnable_code_tests)),
  r("CRAN runnable code vignettes", sum(ALL_CRAN$runnable_code_vignettes)),
)
```

### Kaggle

```{r}
```

```{r}
kaggle <- distinct(ALL_KAGGLE, hash, .keep_all=TRUE)
kaggle_code <- sum(kaggle$code)
kaggle_evals <- filter(kaggle, evals > 0)
kaggle_evals_code <- sum(kaggle_evals$code)

overview_table(
  r("Kaggle kernels", ALL_KAGGLE),
  r("Kaggle duplicates", nrow(ALL_KAGGLE)-nrow(kaggle)),
  r("Kaggle unique", kaggle),
  r("Kaggle code", kaggle_code),
  r("Kaggle competitions", count(kaggle, competition)),
  r("Kaggle with evals", kaggle_evals),
  r("Kaggle with evals code", ratio(kaggle_evals_code, kaggle_code))
)
```


### Matching evals

```{r}
matched_eval_callsites <-
  left_join(
    CRAN_eval_callsites, 
    count(CRAN_eval_traces, eval_call_srcref), 
    by=c("srcref"="eval_call_srcref")
  ) %>%
  mutate(
    n=replace_na(n, 0)
  ) %>%
  rename(hit=n)
```

The dynamic analysis traced `r fmt(ratio(filter(matched_eval_callsites, hit>0), matched_eval_callsites))`

### Plot

```{r}
eval_call_sites_hist <- function(df, df_all, y_lab, max_evals=15L) {
  df %>% 
    mutate(
      evals=if_else(evals < max_evals, evals, max_evals)
    ) %>%
    ggplot(aes(x=evals)) + 
    geom_histogram(binwidth=1, color="black", fill="blue", alpha=0.3) +
    geom_vline(aes(xintercept=mean(df$evals)), linetype="dashed", color="red", size=0.2) +
    scale_x_continuous(
      limits=c(0, max_evals + 1), 
      breaks=as.integer(seq(1, 15, length.out=4)), 
      labels=function(x) c(head(x, -1), str_c(tail(x, 1), "+"))
    ) +
    scale_y_continuous(
      labels=scales::comma_format(accuracy=1),
      sec.axis=sec_axis(
        trans=~./nrow(df_all), 
        labels=scales::percent_format(accuracy=.1), 
        name=y_lab)
    ) +
    labs(x = "Eval call sites", y=y_lab) +
    theme(text = element_text(size=17),
          panel.grid.minor.x = element_blank(), aspect.ratio = 4/3) 
}

eval_call_sites_hist(CRAN, ALL_CRAN, "CRAN packages")
#ggsave(path(PLOT_DIR, "cran-eval-callsites-hist.pdf"))
eval_call_sites_hist(KAGGLE, ALL_KAGGLE, "KAGGLE programs")
#ggsave(path(PLOT_DIR, "kaggle-eval-callsites-hist.pdf"))
```
