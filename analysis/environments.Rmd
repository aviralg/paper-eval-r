---
title: "Environments and eval in R"
author: "Pierre Donat-Bouillud"
output:
  html_document:
        gallery: false
        toc: true
        toc_depth: 3
        toc_float: true
        df_print: paged
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  base_dir: Data/package/
  calls_path: summarized.fst
  corpus_path: corpus.txt
  static_path: evals-static.csv
  force_rebuild: FALSE
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) { # record the current time before each chunk
      now <<- Sys.time()
    } else { # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res, units(res))
    }
  }
}))

knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  fig.retina = 2,
  fig.width = 10,
  cache.lazy = FALSE
)

now <- Sys.time()

library(tidyverse)
library(fst)
library(fs)
library(DT)

source("inc/latextags.R")
source("inc/functions.R")
source("inc/paths.R")
theme_set(theme_minimal())

dataset_name <- basename(params$base_dir)

# Tags will be prefixed by the dataset name
create_tags(path(TAGS_DIR, paste0(dataset_name, "_environments.tex")), prefix = dataset_name, default = TRUE)
# Also use ggsave_prefix instead of ggsave if you need to save a graph

calls_path <- paste0(params$base_dir, params$calls_path)
corpus_path <- paste0(params$base_dir, params$corpus_path)
static_path <- paste0(params$base_dir, params$static_path)

lock_path <- paste0(params$base_dir, ".environments-lock.fst")
min_path <- paste0(params$base_dir, "Eenvir.fst")

nb_eval_call_sites <- function(dataset) {
  dataset %>% pull(src_ref) %>% n_distinct()
}

```

# Loading datafiles

```{r loading_fst}
tibble(package = read_lines(corpus_path)) -> C_raw
read_csv(static_path) %>% semi_join(C_raw, by = "package") -> P

rebuild <- TRUE

E_envir <- NULL

if (file.exists(lock_path)) {
  saved <- read.fst(lock_path)[[1,1]]
  if (saved == file.size(calls_path)) {
    read_fst(min_path) %>% as_tibble() -> E_envir
    rebuild <- FALSE
  }
}

if(params$force_rebuild || rebuild) {
  read_fst(calls_path) %>% as_tibble() %>% semi_join(C_raw, by = c("eval_source" = "package")) -> E_raw
  
  E_raw <- E_raw %>% mutate(envir_expression = if_else(envir_type == "NULL" & is.na(envir_expression), "NULL", envir_expression)) %>% 
    mutate(envir_expression = na_if(envir_expression, "NA"))
  
  E_raw %>% select(
    run_package = package, #      The package which was run to trigger the eval
    ev_variant = eval_function, # Which eval variant was called
    duplicates = nb_ev_calls, #   Number of identical eval calls (weight)
    src_ref = eval_call_srcref, # Source ref for the eval call site
    file, #                       Script file name (name of this run)
    ev_package = eval_source, #   Package of the call site
    type = expr_resolved_type_tag, #   Argument type
    ev_call = eval_call_expression,
    ev_expr = expr_expression,
    n_op = interp_eval,
    envir = envir_expression,
    envir_type,
    caller_expression,
    environment_class,
    enclos = enclos_expression
  ) -> E_envir
  
  
  E_envir %>% write_fst(min_path)
  sz <- file.size(calls_path) %>% as_tibble()
  write.fst(sz, lock_path)
}

C_raw -> C
corpus_size <- nrow(C)
```

# Description of the data files

```{r packages}
nb_eval_calls <- count(E_envir, wt = duplicates)

nb_call_sites <- E_envir %>% pull(src_ref) %>% n_distinct()
```


There are `r nb_eval_calls` eval calls and `r nb_call_sites` eval call sites in the dataset.

# Classification of environments

We distinguish between 5 main categories of `eval` calls with respect to their `envir` argument:

- `envir` is not provided explicitly (and thus is the default argument, which semantically belongs to the absolute category)
- `envir` in an eval call generated by Rcpp
- `envir` is a list or a data frame
- `envir` comes from an argument of the caller function
- `envir` is absolutely computed (with `parent.frame()` or equivalent)
- `envir` is an integer. Then `sys.call` will be used and it is similar to the absolute category
- `envir` is `NULL` and then `enclos` is directly used.

## `envir` as default argument

```{r envir_default}
eval_calls_default <- E_envir %>% filter(is.na(envir)) # yes :(
# Or use E_envir %>% filter(ev_variant == "eval", !str_detect(ev_call, "\\benvir\\b|eval\\([^,]+,"))
# But that regex misses about 1000 sites

nb_default <- count(eval_calls_default, wt = duplicates)
nb_default_sites <- nb_eval_call_sites(eval_calls_default)

eval_calls_explicit <- E_envir %>% filter(!is.na(envir))
nb_explicit <- count(eval_calls_explicit, wt = duplicates)
nb_explicit_sites <- nb_eval_call_sites(eval_calls_explicit)

overview_table(
  r("default envir sites", nb_default_sites),
  r("defaut envir sites percent", ratio(nb_default_sites, nb_call_sites)),
  r("non default envir sites", nb_explicit_sites),
  r("non defaut envir sites percent", ratio(nb_explicit_sites, nb_call_sites))
)
```


There are `r nb_default$n` default calls, which corresponds to `r nb_default_sites` call sites. On the contrary, `r nb_explicit$n` eval calls explicit provide an `envir` argument, which is `r nb_explicit_sites`. The default eval calls are `r ratio(nb_default$n, nb_eval_calls$n)`% of the total and `r ratio(nb_default_sites, nb_call_sites)`% in terms of call sites.

# Most common envir arguments

We show the most frequent environment expression per site. There is only one environment expression per site, as the envir expression is captured before being resolved.

```{r envir_most_common}
frequent_envir <- E_envir %>% group_by(src_ref) %>% 
  summarize(n_envir = n_distinct(envir), envir = paste0(sort(unique(envir)), collapse = " ; "), envir_type = paste0(unique(envir_type), collapse = " ; "), n_types = n_distinct(envir_type)) 

#stopifnot(frequent_envir$n_envir <= 1)
# 2 sites have 2 envir...
```

```{r}
freq_envir <- frequent_envir %>% count(envir, sort = TRUE) %>% 
  mutate(percent = round(100 * n / nb_call_sites, 2), cum_percent = cumsum(percent))

nb_parent.frame_sites <- freq_envir %>% filter(envir == "parent.frame()") %>% .$n
nb_data_sites <- freq_envir %>% filter(envir == "data") %>% .$n

overview_table(
  r("nb parent france sites", nb_parent.frame_sites),
  r("nb parent france site percent", ratio(nb_parent.frame_sites, nb_call_sites)),
  r("nb data sites", nb_data_sites),
  r("nb data sites", ratio(nb_data_sites, nb_call_sites))
)
```

```{r}
freq_envir %>% filter(cum_percent <= 90) %>%
  ggplot() +
  geom_col(aes(x = fct_reorder(envir, percent), y = percent)) + 
  coord_flip()
  
ggsave_prefix("envir_expressions.pdf")
```


Let's classify the expressions, between calls and variables:

```{r}
envir_var <- frequent_envir %>% filter(envir != "NA", str_detect(envir, "^(?:\\.[:alpha]|[:alpha:])[[:alpha:][:digit:]_\\.]*$"))

nb_envir_var_sites <- nrow(envir_var)

overview_table(
  r("envir variable sites", nb_envir_var_sites),
  r("envir variable site percent", ratio(nb_envir_var_sites, nb_explicit_sites))
)
```

# Global ranking of environment classes

```{r}
env_class_ranking <- E_envir %>% group_by(environment_class) %>% 
  summarize(n = n_distinct(src_ref), percent = round(100 * n / nb_call_sites, 2), cumpercent = cumsum(percent)) %>% 
  arrange(desc(n))

env_class_ranking %>% datatable()
```



# Types in `envir`

What about we classify them by type?

```{r}
frequent_envir %>% count(envir_type, sort = TRUE) %>%
  mutate(percent = round(100 * n / nb_call_sites, 2), cumpercent = cumsum(percent)) %>% 
  datatable()
```

And just individual types:

```{r}
E_envir %>% count(envir_type, sort = TRUE)  %>%
  mutate(percent = round(100 * n / nb_call_sites, 2), cumpercent = cumsum(percent)) %>% 
 datatable()
```

We realize that there are some types that are passed to eval that are not admissible according to the documentation.

```{r}
envir_env <- E_envir %>% filter(envir_type %in% c("environment", "S4")) 
# S4 class: from pim package, uses an environment under the hood
envir_unusual <- E_envir %>% filter(envir_type %in% c("list", "integer", "double", "NULL", "pairlist", "S4"))
envir_incorrect <- E_envir %>% anti_join(envir_env) %>% anti_join(envir_unusual)

nb_envir_env_sites <- envir_env %>% pull(src_ref) %>% n_distinct()
nb_envir_unusual_sites <- envir_unusual %>% pull(src_ref) %>% n_distinct()
nb_envir_incorrect_sites <- envir_incorrect %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb envir env sites", nb_envir_env_sites),
  r("envir env site percent", ratio(nb_envir_env_sites, nb_call_sites)),
  r("nb envir unusual sites", nb_envir_unusual_sites),
  r("envir unusual site percent", ratio(nb_envir_unusual_sites, nb_call_sites)),
  r("nb envir incorrect sites", nb_envir_incorrect_sites),
  r("envir incorrect site percent", ratio(nb_envir_incorrect_sites, nb_call_sites)),
)
```


##  `envir` as a list or data frame

```{r envir_list}
eval_calls_env_list <- eval_calls_explicit %>% filter(envir_type == "list")

nb_env_list <- count(eval_calls_env_list, wt = duplicates)
nb_env_list_sites <- nb_eval_call_sites(eval_calls_env_list)

overview_table(
  r("nb env list", nb_env_list),
  r("nb env list sites", nb_env_list_sites),
  r("nb env list site percent", ratio(nb_env_list_sites, nb_call_sites))
)
```

## `envir` as an argument from the caller function

```{r envir_arg_caller, eval = FALSE}
eval_calls_arg_caller <- eval_calls_explicit %>% filter(!is.na(envir_from_arg))

nb_arg_caller <- count(eval_calls_arg_caller, wt = duplicates)
nb_arg_caller_sites <- nb_eval_call_sites(eval_calls_arg_caller)
```


Most of the eval calls directly use the argument, but some seem to modify it a lot:

```{r eval = FALSE}
eval_calls_arg_caller %>%
  count(envir_from_arg, wt = duplicates, sort = TRUE) %>%
  knitr::kable()
```


In the current dataset, there are no examples of sandbox usage but we should see a distance of 1 in that case.


## `envir` absolutely computed

```{r envir_absolute}
eval_calls_absolute <- eval_calls_explicit %>% filter(envir_type %in% c("environment", "S4"))

nb_absolute <- count(eval_calls_absolute, wt = duplicates)
nb_absolute_sites <- nb_eval_call_sites(eval_calls_absolute)

overview_table(
  r("nb absolute envir", nb_absolute$n),
  r("nb absolute sites", nb_absolute_sites),
  r("nb absolute site percent", ratio(nb_absolute_sites, nb_eval_calls))
)
```

Let's do a sanity check: is the environment class the same in that category?

```{r}
absolute_diversity <- eval_calls_absolute %>%
  group_by(src_ref) %>%
  summarize(envir_distinct = n_distinct(environment_class), envir = paste0(unique(environment_class), collapse = " ; "))

absolute_diversity %>%
  count(envir_distinct, sort = TRUE)

absolute_diversity %>%
  count(envir, sort = TRUE)
```


Now, we can further decompose the environment class to get more insights. It has three components:

- how many times it has been wrapped in `new`
- how far (in terms of hierarchy of environments) it is from the callee
- does it correspond to any distinguished environment? ( `global`, `empty`, `base`, `callee`, or some package environment

```{r}
# new+new+new+new+caller-2-global
# str_match("caller-2-", "((?:new\\+)*)caller-([[:digit:]]+)-(.*)")

env_calls <- E_envir %>% filter(envir_type %in% c("environment", "S4")) %>%
  extract(environment_class, regex = "((?:new\\+)*)(?:caller-(-?[[:digit:]]+)-)?(.*)", into = c("new_env", "hierarchy", "specific_env"), remove = FALSE, convert = TRUE) %>%
  mutate(new_env = na_if(new_env, ""), specific_env = na_if(specific_env, ""), new_env = str_count(new_env, fixed("new+"))) %>%
  mutate(specific_env = if_else(specific_env == "emptyR_EmptyEnv", "empty", specific_env)) 
```

```{r}
env_calls %>% group_by(new_env) %>% summarize(n = n_distinct(src_ref), percent = round(100 * n / nb_call_sites, 2), cum_percent = cumsum(percent)) %>% arrange(desc(n))

env_calls %>% group_by(hierarchy) %>% summarize(n = n_distinct(src_ref), percent = round(100 * n / nb_call_sites, 2), cum_percent = cumsum(percent)) %>% arrange(desc(n))


```




# Specific environments


```{r}
specific_env <- env_calls %>% group_by(specific_env) %>% summarize(n = n_distinct(src_ref), n_packages = n_distinct(ev_package), percent = round(100 * n / nb_call_sites, 2), cum_percent = cumsum(percent)) %>% arrange(desc(n))

nb_global_env_sites <- specific_env %>% filter(specific_env == "global") %>% .$n
nb_callee_env_sites <- specific_env %>% filter(specific_env == "callee") %>% .$n # Seems it is actually for envir == "new.env()"
if(length(nb_callee_env_sites) == 0) nb_callee_env_sites <- 0
nb_empty_env_sites <- specific_env %>% filter(specific_env == "empty") %>% .$n
if(length(nb_empty_env_sites) == 0) nb_empty_env_sites <- 0
nb_base_env_sites <- specific_env %>% filter(specific_env == "base") %>% .$n
if(length(nb_base_env_sites) == 0) nb_base_env_sites <- 0

overview_table(
  r("nb global env sites", nb_global_env_sites),
  r("nb global env site percent", ratio(nb_global_env_sites, nb_call_sites)),
  r("nb callee env sites", nb_callee_env_sites),
  r("nb callee env site percent", ratio(nb_callee_env_sites, nb_call_sites)),
  r("nb empty env sites", nb_empty_env_sites),
  r("nb empty env site percent", ratio(nb_empty_env_sites, nb_call_sites)),
  r("nb base env sites", nb_base_env_sites),
  r("nb base env site percent", ratio(nb_base_env_sites, nb_call_sites))
)
```

Glabal can happen by chance, because `parent.frame()`goes up too much and reaches the global environment. So when is it explicitly passed?

```{r}
explicit_global <- E_envir %>% filter(envir %in% c("globalenv()", ".GlobalEnv"))

nb_explicit_global_sites <- explicit_global %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb explicit global sites", nb_explicit_global_sites),
  r("nb explicit global site percent", ratio(nb_explicit_global_sites, nb_call_sites))
)
```

And when is it passed through a variable?

```{r}
variable_global <- E_envir %>% filter(environment_class == "global") %>% semi_join(envir_var)

nb_variable_global_sites <- variable_global %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb variable global sites", nb_variable_global_sites),
  r("nb variable global site percent", ratio(nb_variable_global_sites, nb_call_sites))
)
```

So we can deduce an approximate (upper-bound) of the number of sites that touch eval not by chance!

## Package environments

Our tracer leaks here: 3 srcref are seeing `package:evil`, from `test_that`, `R.oo` and `envnames`.

What are the ones looking into packages?

```{r}
package_env <- E_envir %>% filter(str_detect(environment_class, fixed("package:"))) %>% count(ev_package, sort = TRUE)

nb_package_env_sites <- E_envir %>% filter(str_detect(environment_class, fixed("package:"))) %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb package env packages", nrow(package_env)),
  r("nb package env sites", nb_package_env_sites),
  r("package env site percent", ratio(nb_package_env_sites, nb_call_sites))
)
```

They are the following:

- _R.oo_: OOP system
- _USSCXenaTools_: uses `eval` to create _hidden_ function inside its own namespace (by pasting `".p_"` in front of the function name)
- _unitizer_: unit test framework that requires to precise the test environment
- _envnames_: seach env by names, give a name for each environments. Traverse all the call sites with `sys.calls`
- _testthat_: unit test framework


## Weird packages

There are 3 weird _package_ environments: `.R_Cache`, `.R_Test`, `newdir...`

They all seem to implement a kind of caching mechanism. 

They build the environment name with:

```{r, eval = FALSE}
env <- attach(NULL, pos, basename(directory))
```

## Namespaces

In R, namespaces are different from the package environment.

```{r}
namespace_envs <- E_envir %>% filter(!str_detect(environment_class, fixed("caller-")), !str_detect(environment_class, "global|empty|base|loop"), !str_detect(environment_class, fixed("package:")))

nb_namespace_env_sites <- namespace_envs %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb namespace env sites", nb_namespace_env_sites),
  r("nb namespace env site percent", ratio(nb_namespace_env_sites, nb_call_sites))
)
```

What are the most frequent namespaces?

```{r}
namespace_envs %>% count(environment_class, wt = duplicates, sort = TRUE) %>%
  mutate(pc = ratio(n, sum(n)), cpc = cumsum(pc))

namespace_envs %>% group_by(environment_class) %>% 
  summarise(n = n_distinct(src_ref)) %>% 
  arrange(desc(n)) %>% 
   mutate(pc = ratio(n, sum(n)), cpc = cumsum(pc))
```


# `envir` is an integer

```{r envir_integer}
eval_calls_integer <- eval_calls_explicit %>% filter(envir_type == "integer")

nb_integer <- count(eval_calls_integer, wt = duplicates)$n
nb_integer_sites <- nb_eval_call_sites(eval_calls_integer)

overview_table(
  r("nb integer envir", nb_integer),
  r("nb integer envir sites", nb_integer_sites),
  r("nb integer envir site percent", ratio(nb_integer_sites, nb_call_sites))
)
```

# `envir` is `NULL`

```{r envir_null}
eval_calls_null <- eval_calls_explicit %>% filter(envir_type == "NULL")

nb_null <- count(eval_calls_null, wt = duplicates)$n
nb_null_sites <- nb_eval_call_sites(eval_calls_null)

overview_table(
  r("nb null envir", nb_null),
  r("nb null envir sites", nb_null_sites),
  r("nb null envir site percent", ratio(nb_null_sites, nb_call_sites))
)
```

# `enclos` argument

```{r}
enclos_present <- E_envir %>% filter(!is.na(enclos))

nb_enclos_sites <- enclos_present %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb enclos sites", nb_enclos_sites),
  r("enclos site percent", ratio(nb_enclos_sites, nb_call_sites))
)
```

To which type of `envir`is it associated? It should be either pairlists, data frames (list) or NULL (NULL being interpreted as the empty list).

```{r}
enclos_types <- enclos_present %>% group_by(envir_type) %>% 
  summarize(n = n_distinct(src_ref)) %>% 
  arrange(desc(n)) %>% 
  datatable()

nb_enclos_with_list_sites <- enclos_present %>% 
  filter(envir_type %in% c("list", "NULL")) %>% 
  pull(src_ref) %>% 
  n_distinct()

overview_table(
  r("nb enclos with list sites", nb_enclos_with_list_sites),
  r("enclos with list percent", ratio(nb_enclos_with_list_sites, nb_enclos_sites))
)
```


# Better-looking env class

A specific env wins over `caller-n`. We add `+` if there are any `new`.



```{r}
env_classes <- env_calls %>%
  mutate(env_class = if_else(environment_class == "loop", "loop", paste0(if_else(is.na(specific_env), as.character(hierarchy), specific_env), if_else(is.na(new_env), "", "+"))))

not_env_calls <- E_envir %>% anti_join(env_classes) %>% 
  mutate(env_class = case_when(
    envir_type == "list" ~ "list",
    envir_type == "integer" ~ "int",
    envir_type == "NULL" ~ "NULL",
    TRUE ~ "other"
  ))

env_classes <- bind_rows(env_classes, not_env_calls)

env_classes_calls <- env_classes %>% count(env_class, wt = duplicates, sort = TRUE) %>%
  mutate(pc = ratio(n, nb_eval_calls), cpc = cumsum(pc)) 

env_classes_sites <- env_classes %>% group_by(env_class) %>% summarise(n = n_distinct(src_ref)) %>%
  arrange(desc(n)) %>%
  mutate(pc = ratio(n, nb_call_sites), cpc = cumsum(pc)) 
```


```{r}
env_classes_calls %>% datatable()

env_classes_sites %>% datatable()

nrows <- 8
r_vec("env class names", nrows, env_classes_sites$env_class)
r_vec("env class sites", nrows, env_classes_sites$n)
r_vec("env class site percent", nrows, env_classes_sites$pc)
```


# Less fine-grained classification

We categorize environments in:

- function environments (parent frames and integer)
- package/namespace environments
- list/NULL environments
- global environment
- new environment
- empty environment

## Caller environments

```{r}
caller_envs <- env_calls %>% filter(!is.na(hierarchy), is.na(specific_env))
nb_caller_env_sites <- caller_envs %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb caller env sites", nb_caller_env_sites),
  r("caller env site percent", ratio(nb_caller_env_sites, nb_call_sites))
)
```


## New environments

```{r}
new_envs <- env_calls %>% filter(!is.na(new_env))
nb_new_env_sites <- new_envs %>% pull(src_ref) %>% n_distinct()

overview_table(
  r("nb new env sites", nb_new_env_sites),
  r("new env site percent", ratio(nb_new_env_sites, nb_call_sites))
)
```


We classify the most specific environment or caller environment after it.
```{r}
env_classes %>% filter(!is.na(new_env)) %>% group_by(env_class) %>% 
  summarise(n = n_distinct(src_ref)) %>% 
  arrange(desc(n)) %>% 
  mutate(pc = ratio(n, nb_call_sites), cpc = cumsum(pc))
```


And with the higher-level categories:

```{r}
high_level_new <- env_calls %>% filter(!is.na(new_env)) %>% 
  mutate(category = case_when(
    !is.na(hierarchy) ~ "function",
    specific_env == "global" ~ "global",
    specific_env == "empty" ~ "empty",
    str_detect(specific_env, fixed("loop")) ~ "other",
    !is.na(specific_env) ~ "package"
  ))

high_level_new_sites <- high_level_new %>%group_by(category) %>%
  summarise(n = n_distinct(src_ref)) %>% 
  arrange(desc(n)) %>% 
  mutate(pc = ratio(n, nb_new_env_sites), cpc = cumsum(pc))


nrows <- 5
r_vec("new env category name", nrows, high_level_new_sites$category)
r_vec("new env category sites", nrows, high_level_new_sites$n)
r_vec("new env category site percent", nrows, high_level_new_sites$pc)
```

## The final high-lelve classification

```{r}
nb_dataframe_env_sites <- nb_env_list_sites + nb_null_sites

nb_pack_sites <- nb_package_env_sites + nb_namespace_env_sites + nb_base_env_sites

nb_function_env_sites <- nb_caller_env_sites + nb_integer_sites

overview_table(
  r("nb dataframe env sites", nb_dataframe_env_sites),
  r("nb dataframe env site percent", ratio(nb_dataframe_env_sites, nb_call_sites)),
  r("nb package namespace env sites", nb_pack_sites),
  r("nb package namespace env site percent", ratio(nb_pack_sites, nb_call_sites)),
  r("nb function env sites", nb_function_env_sites),
  r("nb function env site percent", ratio(nb_function_env_sites, nb_call_sites))
)
```




# Specific envir with their environment class

For the default argument:

```{r}
eval_calls_default %>% count(environment_class, wt = duplicates, sort = TRUE) %>%
  mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

eval_calls_default %>% group_by(environment_class) %>% summarise(n = n_distinct(src_ref)) %>%
  arrange(desc(n)) %>%
   mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

# caller-2- is eval.parent
eval_calls_default %>% filter(environment_class == "caller-2-") %>% count(ev_variant)
  
```

`eval` is not problematic:

```{r}
eval_calls_default %>% filter(ev_variant == "eval") %>% count(environment_class, wt = duplicates, sort = TRUE)
```

But `eval.parent` is:

```{r}
eval_calls_default %>% filter(ev_variant == "eval.parent") %>% count(environment_class, wt = duplicates, sort = TRUE)
```

It might be because `parent.frame` is equivalent to  `sys.frame(sys.parent(n))` and `sys.parent(n)` can get surprising result of it is called near the top level...

For `parent.frame()` :

```{r}
E_envir %>% filter(envir == "parent.frame()") %>% count(environment_class, wt = duplicates, sort = TRUE) %>%
  mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

E_envir %>% filter(envir == "parent.frame()") %>% group_by(environment_class) %>%
  summarise(n = n_distinct(src_ref)) %>%
  arrange(desc(n)) %>%
   mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

```

For `new.env()`:

```{r}
E_envir %>% filter(envir == "new.env()") %>% count(environment_class, wt = duplicates, sort = TRUE) %>%
  mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

E_envir %>% filter(envir == "new.env()") %>% group_by(environment_class) %>%
  summarise(n = n_distinct(src_ref)) %>%
  arrange(desc(n)) %>%
   mutate(pc = round(100 * n / sum(n), 2), cpc = cumsum(pc)) 

```

For each envir expression, what is the most common environment class? (in calls, in sites)

```{r}
env_class_envir <- E_envir %>% group_by(envir) %>%
  group_by(environment_class, .add = TRUE) %>% summarise(n = n_distinct(src_ref)) %>%
  summarise(env_class = first(environment_class, order_by = order(n, decreasing = TRUE)), n = sum(n)) %>% 
  arrange(desc(n))
```


```{r}
duration <- difftime(Sys.time(), now)
```

Notebook execution was `r duration` `r units(duration)`.
