---
title: "Environments and eval in R"
author: "Pierre Donat-Bouillud"
output:
  html_document:
        gallery: false
        toc: true
        toc_depth: 3
        toc_float: true
        df_print: paged
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  base_dir: Data/package/
  calls_path: summarized.fst
  corpus_path: corpus.txt
  static_path: evals-static.csv
  force_rebuild: FALSE
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) { # record the current time before each chunk
      now <<- Sys.time()
    } else { # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res, units(res))
    }
  }
}))

knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  fig.retina = 2,
  fig.width = 10,
  cache.lazy = FALSE
)

now <- Sys.time()

library(tidyverse)
library(fst)
library(fs)
library(DT)

source("inc/latextags.R")
source("inc/functions.R")
source("inc/paths.R")
theme_set(theme_minimal())

dataset_name <- basename(params$base_dir)

# Tags will be prefixed by the dataset name
create_tags(path(TAGS_DIR, paste0(dataset_name, "_environments.tex")), prefix = dataset_name, default = TRUE)
# Also use ggsave_prefix instead of ggsave if you need to save a graph

calls_path <- paste0(params$base_dir, params$calls_path)
corpus_path <- paste0(params$base_dir, params$corpus_path)
static_path <- paste0(params$base_dir, params$static_path)

lock_path <- paste0(params$base_dir, ".environments-lock.fst")
min_path <- paste0(params$base_dir, "Eenvir.fst")

nb_eval_call_sites <- function(dataset) {
  dataset %>% pull(src_ref) %>% n_distinct()
}

```

# Loading datafiles

```{r loading_fst}
tibble(package = read_lines(corpus_path)) -> C_raw
read_csv(static_path) %>% semi_join(C_raw, by = "package") -> P

rebuild <- TRUE

E_envir <- NULL

if (file.exists(lock_path)) {
  saved <- read.fst(lock_path)[[1,1]]
  if (saved == file.size(calls_path)) {
    read_fst(min_path) %>% as_tibble() -> E_envir
    rebuild <- FALSE
  }
}

if(params$force_rebuild || rebuild) {
  read_fst(calls_path) %>% as_tibble() -> E_raw
  
  E_raw <- E_raw %>% mutate(envir_expression = if_else(envir_type == "NULL" & is.na(envir_expression), "NULL", envir_expression))
  
  E_raw %>% select(
    run_package = package, #      The package which was run to trigger the eval
    ev_variant = eval_function, # Which eval variant was called
    duplicates = nb_ev_calls, #   Number of identical eval calls (weight)
    src_ref = eval_call_srcref, # Source ref for the eval call site
    file, #                       Script file name (name of this run)
    ev_package = eval_source, #   Package of the call site
    type = expr_resolved_type_tag, #   Argument type
    ev_expr = expr_expression,
    n_op = interp_eval,
    envir = envir_expression,
    envir_type,
    caller_expression,
    environment_class
  ) -> E_envir
  
  
  E_envir %>% write_fst(min_path)
  sz <- file.size(calls_path) %>% as_tibble()
  write.fst(sz, lock_path)
}

C_raw -> C
corpus_size <- nrow(C)
```

# Description of the data files

```{r packages}
nb_eval_calls <- count(E_envir, wt = duplicates)

nb_call_sites <- E_envir %>% pull(src_ref) %>% n_distinct()
```


There are `r nb_eval_calls` eval calls and `r nb_call_sites` eval call sites in the dataset.

# Classification of environments

We distinguish between 5 main categories of `eval` calls with respect to their `envir` argument:

- `envir` is not provided explicitly (and thus is the default argument, which semantically belongs to the absolute category)
- `envir` in an eval call generated by Rcpp
- `envir` is a list or a data frame
- `envir` comes from an argument of the caller function
- `envir` is absolutely computed (with `parent.frame()` or equivalent)
- `envir` is an integer. Then `sys.call` will be used and it is similar to the absolute category
- `envir` is `NULL` and then `enclos` is directly used.

## `envir` as default argument

```{r envir_default}
eval_calls_default <- E_envir %>% filter(is.na(envir))

nb_default <- count(eval_calls_default, wt = duplicates)
nb_default_sites <- nb_eval_call_sites(eval_calls_default)

eval_calls_explicit <- E_envir %>% filter(!is.na(envir))
nb_explicit <- count(eval_calls_explicit, wt = duplicates)
nb_explicit_sites <- nb_eval_call_sites(eval_calls_explicit)

overview_table(
  r("default envir sites", nb_default_sites),
  r("defaut envir sites percent", ratio(nb_default_sites, nb_call_sites)),
  r("non default envir sites", nb_explicit),
  r("non defaut envir sites percent", ratio(nb_explicit, nb_call_sites))
)
```


There are `r nb_default$n` default calls, which corresponds to `r nb_default_sites` call sites. On the contrary, `r nb_explicit$n` eval calls explicit provide an `envir` argument, which is `r nb_explicit_sites`. The default eval calls are `r ratio(nb_default$n, nb_eval_calls$n)`% of the total and `r ratio(nb_default_sites, nb_call_sites)`% in terms of call sites.

# Most common envir arguments

We show the most frequent environment expression per site. There is only one environment expression per site, as the envir expression is captured before being resolved.

```{r envir_most_common}
frequent_envir <- E_envir %>% group_by(src_ref) %>% 
  summarize(n_envir = n_distinct(envir), envir = paste0(unique(envir), collapse = " ; "))

stopifnot(frequent_envir$n_envir <= 1)
```


# `envir` with Rcpp

```{r envir_rcpp}
eval_calls_rcpp <- eval_calls_explicit %>% filter(str_detect(expr_expression, "C\\+\\+Constructor|C\\+\\+Field|C\\+\\+OverloadedMethods"))

nb_rcpp <- count(eval_calls_rcpp, wt = duplicates)
nb_rcpp_sites <- nb_eval_call_sites(eval_calls_rcpp)

eval_calls_explicit <- eval_calls_explicit %>% anti_join(eval_calls_rcpp)
```



##  `envir` as a list or data frame

```{r envir_list}
eval_calls_env_list <- eval_calls_explicit %>% filter(envir_type == "list")

nb_env_list <- count(eval_calls_env_list, wt = duplicates)
nb_env_list_sites <- nb_eval_call_sites(eval_calls_env_list)
```

## `envir` as an argument from the caller function

```{r envir_arg_caller}
eval_calls_arg_caller <- eval_calls_explicit %>% filter(!is.na(envir_from_arg))

nb_arg_caller <- count(eval_calls_arg_caller, wt = duplicates)
nb_arg_caller_sites <- nb_eval_call_sites(eval_calls_arg_caller)
```


Most of the eval calls directly use the argument, but some seem to modify it a lot:

```{r}
eval_calls_arg_caller %>%
  count(envir_from_arg, wt = duplicates, sort = TRUE) %>%
  knitr::kable()
```


In the current dataset, there are no examples of sandbox usage but we should see a distance of 1 in that case.


## `envir` absolutely computed

```{r envir_absolute}
eval_calls_absolute <- eval_calls_explicit %>%
  anti_join(eval_calls_env_list) %>%
  anti_join(eval_calls_arg_caller)

nb_absolute <- count(eval_calls_absolute, wt = duplicates)
nb_absolute_sites <- nb_eval_call_sites(eval_calls_absolute)
```

Let's do a sanity check: is the environment class the same in that category?

```{r}
eval_calls_absolute <- eval_calls_absolute %>%
  group_by(eval_call_srcref) %>%
  mutate(envir_distinct = n_distinct(environment_class))

eval_calls_absolute %>%
  ungroup() %>%
  count(envir_distinct, sort = TRUE)
```

We can also see a few examples:

```{r}
eval_calls_absolute %>%
  filter(envir_distinct == 2) %>%
  select(ev_expr, environment_class, envir_distinct)
```

Now, we can further decompose the environment class to get more insights. It has three components:

- how many times it has been wrapped in `new`
- how far (in terms of hierarchy of environments) it is from the callee
- does it correspond to any distinguished environment? ( `global`, `empty`, `base`, `callee`, or some package environment

```{r}
# new+new+new+new+caller-2-global
# str_match("caller-2-", "((?:new\\+)*)caller-([[:digit:]]+)-(.*)")


env_calls <- eval_calls_absolute %>% ungroup() %>%
  extract(environment_class, regex = "((?:new\\+)*)caller-([[:digit:]]+)-(.*)", into = c("new_env", "hierarchy", "specific_env"), remove = FALSE, convert = TRUE) %>%
  mutate(new_env = na_if(new_env, ""), specific_env = na_if(specific_env, ""), new_env = str_count(new_env, fixed("new+"))) %>%
  mutate(specific_env = if_else(specific_env == "emptyR_EmptyEnv", "empty", specific_env))
```

_ggplot2_ again is responsible for this `new.env` 4 times!

```{r}
env_calls %>% filter(!is.na(new_env), specific_env == "global") %>% count(new_env, wt = duplicates, sort = TRUE)

env_calls %>% filter(new_env == 4, specific_env == "global") %>% count(eval_source, wt = duplicates, sort = TRUE)
```


# `envir` is an integer

```{r envir_integer}
eval_calls_integer <- eval_calls_explicit %>% filter(envir_type == "integer")

nb_integer <- count(eval_calls_integer, wt = duplicates)
nb_integer_sites <- nb_eval_call_sites(eval_calls_integer)
```

# `envir` is `NULL`

```{r envir_null}
eval_calls_null <- eval_calls_explicit %>% filter(envir_type == "NULL")

nb_null <- count(eval_calls_null, wt = duplicates)
nb_null_sites <- nb_eval_call_sites(eval_calls_null)
```

## Summary of the categories

Total eval calls: `r nb_eval_calls`

Total eval call sites: `r nb_call_sites`


```{r summary}
summary <- tribble(
  ~category, ~calls, ~percent_calls, ~callsites, ~percent_callsites,
  "Default", nb_default$n, ratio(nb_default$n, nb_eval_calls$n), nb_default_sites, ratio(nb_default_sites, nb_call_sites),
  "Rcpp", nb_rcpp$n, ratio(nb_rcpp$n, nb_eval_calls$n), nb_rcpp_sites, ratio(nb_rcpp_sites, nb_call_sites),
  "List or dataframe", nb_env_list$n, ratio(nb_env_list$n, nb_eval_calls$n), nb_env_list_sites, ratio(nb_env_list_sites, nb_call_sites),
  "Argument of caller", nb_arg_caller$n, ratio(nb_arg_caller$n, nb_eval_calls$n), nb_arg_caller_sites, ratio(nb_arg_caller_sites, nb_call_sites),
  "Absolute", nb_absolute$n, ratio(nb_absolute$n, nb_eval_calls$n), nb_absolute_sites, ratio(nb_absolute_sites, nb_call_sites),
  "Integer", nb_integer$n, ratio(nb_integer$n, nb_eval_calls$n), nb_integer_sites, ratio(nb_integer_sites, nb_call_sites),
  "Null", nb_null$n, ratio(nb_null$n, nb_eval_calls$n), nb_null_sites, ratio(nb_null_sites, nb_call_sites),
)

summary %>% datatable(colnames = c("", "Eval calls", "%", "Call sites", "%"))
```


```{r}
duration <- difftime(Sys.time(), now)
```

Notebook execution was `r duration` `r units(duration)`.
