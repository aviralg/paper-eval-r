---
title: "Corpus Analysis"
output: html_document
params:
  base_dir: ../../../
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
for (x in c(
  "dplyr", 
  "DT",
  "fs",
  "fst",
  "ggplot2",
  "ggthemes",
  "lubridate",
  "readr",
  "purrr",
  "stringr",
  "tidyr",
  "viridis"
  )) {
  suppressPackageStartupMessages(library(x, character.only=TRUE))
}

knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  fig.retina = 2,
  fig.width = 10
)

# TODO: move into the package
source("inc/paths.R")
source("inc/setup.R")
source("inc/latextags.R")

options(repos="https://cran.r-project.org")
theme_set(theme_minimal())
create_tags(path(TAGS_DIR, "corpus.tex"), prefix="Corpus", default=TRUE)
```

## Load data

```{r load corpus}
corpus <- 
  read_fst(CORPUS_DETAILS_FILE) %>%
  as_tibble() %>%
  mutate_at(
    vars(
      starts_with("runnable_code"),
      starts_with("runnable_files"),
      starts_with("package_"),
      starts_with("funs_"),
    ), 
    replace_na, 
    0
  )
```

```{r load kaggle}
kaggle_kernels <- as_tibble(read_fst(KAGGLE_KERNELS_FILE))
kaggle_log <- as_tibble(read_fst(KAGGLE_LOG_FILE)) %>%
  transmute(
    id=str_replace(Command, ".*/kaggle-run/[^/]+/([^/]+)/.*", "\\1"),
    exitval=Exitval,
    runtime=as.duration(JobRuntime)
  )

kaggle <- left_join(
  kaggle_kernels,
  kaggle_log,
  by="id"
)
```

```{r load runnable code metadata}
runnable_code_metadata <- read_fst(PACKAGE_RUNNABLE_CODE_FILE) %>%
  as_tibble() %>%
  mutate(package=basename(package)) %>%
  select(package, file=filename, code)

# TODO semi_join with traced-programs.fst
```

```{r load run metadata}
runs <- read_fst(PACKAGE_RUNS_FILE) %>%
  as_tibble() %>%
  mutate(
    package=basename(package),
    file=as.character(path("./", basename(dirname(file)), basename(file)))
  ) %>%
  semi_join(corpus, by="package")
```


## CRAN packages

```{r summary}
corpus_runtime  <- corpus$runnable_time / corpus$runnable_files
runnable_code   <- corpus$runnable_code
corpus_programs_files <- corpus$runnable_files

overview_table(
  r("packages",             corpus),
  r("in cranlogs",          filter(corpus, !is.na(rank))),
  r("package programs",     sum(corpus_programs_files)),

  r("runnable code",        sum(runnable_code)),
  r("runnable code mean",   mean(runnable_code)),
  r("runnable code median", median(runnable_code)),
  
  r("examples code",        sum(corpus$runnable_code_examples)),
  r("tests code",           sum(corpus$runnable_code_tests)),
  r("vignettes code",       sum(corpus$runnable_code_vignettes)),
  
  r("mean expr coverage",   percent(mean(corpus$coverage_expr))),
  r("median expr coverage", percent(median(corpus$coverage_expr))),
  
  r("with R code",          filter(corpus, package_r_code > 0)),
  r("with native code",     filter(corpus, package_native_code > 0)),
  
  r("code",                 sum(corpus$package_code)),
  r("R code",               sum(corpus$package_r_code)),
  r("R code mean",          mean(corpus$package_r_code)),
  r("R code median",        median(corpus$package_r_code)),
  r("native code",          sum(corpus$package_native_code)),
  r("native code mean",     mean(corpus$package_native_code)),
  r("native code median",   median(corpus$package_native_code)),
  
  r("functions",            sum(corpus$funs_public+corpus$funs_private)),
  r("function with eval",   sum(corpus$funs_with_eval)),
  r("public functions",     sum(corpus$funs_public)),
  r("private functions",    sum(corpus$funs_private)),
  
  r("mean revdes",          mean(corpus$revdeps)),
  r("median revdes",        median(corpus$revdeps)),
  
  r("runtime",              as.duration(sum(corpus$runnable_time))),
  r("mean runtime",         as.duration(mean(corpus_runtime))),
  r("median runtime",       as.duration(median(corpus_runtime)))
)
```

```{r generals}
overview_table(
  r("all cran", dim(available.packages())[1]),
  r("core packages", length(CORE_PACKAGES)),
  r("most downloaded treshold", MOST_DOWNLOADED),
  r("large package treshold", PACKAGE_SIZE_OUTLIER)
)
```

### Plot

```{r plot corpus}
coverage_mean   <- mean(corpus$coverage_expr)
coverage_median <- median(corpus$coverage_expr)
revdeps_mean    <- mean(corpus$revdeps)
revdeps_median  <- median(corpus$revdeps)
  
corpus %>%
  mutate(
    outlier=package_code > PACKAGE_SIZE_OUTLIER,
    label=ifelse(rank <= MOST_DOWNLOADED | outlier, package, NA)  #if_else(outlier, str_glue("{package}"), as.character(NA))
  ) %>%
  ggplot(
    aes(
      x=coverage_expr, 
      y=revdeps,
      label=label,
      size=package_code
    )
  ) +
  geom_point(alpha=.6) +
  geom_text(size=2, check_overlap = T, vjust=1.5, na.rm = TRUE) + 
  
  geom_hline(aes(yintercept=revdeps_mean), linetype="dashed", color="red", size=0.2) +
  geom_vline(aes(xintercept=coverage_mean), linetype="dashed", color="red", size=0.2) +

  scale_x_continuous(labels = scales::percent) + 
  scale_y_log10(labels = scales::comma) +
  scale_size(range = c(.1, 3), labels = scales::comma) +
  theme(
    legend.position=c(0.2, 0.85),
    legend.box="horizontal",
    legend.box.background = element_rect(fill="white", size=0.1)
  ) +
  labs(
    x="Code coverage", 
    y="Number of reverse dependencies (log)", 
    size="Code size (R + native)",
    linetype=""
  ) +
  guides(
    size=guide_legend(order=1),
    color=guide_legend(order=2),
    linetype=F
  )

ggsave(CORPUS_PLOT)
```

### List of corpus packages

```{r list of packages, eval=FALSE}
datatable(
  corpus, 
  filter="top", 
  options=list(
    pageLength=50,
    autoWidth=TRUE
  )
)
```

## Kaggle

```{r kaggle summary}
kaggle_runnable <- filter(kaggle, runnable)
kaggle_finished <- filter(kaggle, exitval==0)
kaggle_code     <- kaggle_finished$code
kaggle_runtime  <- kaggle_finished$runtime

overview_table(
  r("kaggle",                 kaggle),
  r("runnable kaggle",        kaggle_runnable),
  r("finished kaggle",        kaggle_finished),
  r("finished kaggle code",   sum(kaggle_code)),
  r("finished kaggle mean",   mean(kaggle_code)),
  r("finished kaggle median", median(kaggle_code)),
  r("kaggle runtime",         as.duration(sum(kaggle_runtime))),
  r("kaggle mean",            as.duration(mean(kaggle_runtime))),
  r("kaggle median",          as.duration(median(kaggle_runtime)))
)
```

## Combined

```{r all summary}
overview_table(
  r("all programs", nrow(kaggle_finished) + sum(corpus_programs_files)),
  r("all runnbale code", sum(kaggle_code) + sum(runnable_code)),
  r("all code", sum(kaggle_code) + sum(corpus$package_code) + sum(runnable_code))
)
```

```{r compute programs}
corpus_programs <-
  left_join(
    filter(runs, exitval==0) %>% select(package, file, time), 
    runnable_code_metadata %>% select(package, file, code),
    by=c("package", "file")
  ) %>%
  transmute(id=paste(package, ":", file), code, runtime=time, corpus="packages")

kaggle_programs <-
  kaggle %>%
  filter(exitval==0) %>%
  transmute(id, code, runtime=as.numeric(runtime, units="seconds"), corpus="kaggle")

programs <- bind_rows(corpus_programs, kaggle_programs)
```

```{r}
programs %>%
  ggplot(aes(y=code, x=corpus, fill=corpus)) + 
  geom_flat_violin(trim=FALSE, width=.5) +
  geom_dotplot(
    binaxis="y", 
    dotsize=0.1, 
    stackdir="down", 
    binwidth=0.01, 
    position=position_nudge(-0.025)) +
  scale_y_log10(labels = scales::comma) +
  scale_x_discrete(labels=c("kaggle"="Kaggle", "packages"="Packages")) +
  scale_fill_viridis(discrete = TRUE) +
  guides(fill = FALSE) +
  labs(y="Code size (log)") +
  theme(
    legend.box="horizontal",
    axis.title.x=element_blank()
  )

ggsave(path(PLOT_DIR, "programs-code.pdf"), width=7, height=5.5)
```

```{r}
programs %>%
  ggplot(aes(y=runtime, x=corpus, fill=corpus)) + 
  geom_flat_violin(trim=FALSE, width=.5) +
  geom_dotplot(
    binaxis="y", 
    dotsize=0.1, 
    stackdir="down", 
    binwidth=0.01, 
    position=position_nudge(-0.025)) +
  scale_y_log10(labels = function(x, ...) {
    min <- as.integer(x/60L)
    sec <- as.integer(x%%60L)
    sprintf("%.2d:%.2d", min, sec)
  }) +
  scale_x_discrete(labels=c("kaggle"="Kaggle", "packages"="Packages")) +
  scale_fill_viridis(discrete = TRUE) +
  guides(fill = FALSE) +
  labs(y="Running time [mm:ss] (log)") +
  theme(
    legend.box="horizontal",
    axis.title.x=element_blank()
  )
ggsave(path(PLOT_DIR, "programs-runtime.pdf"), width=3.5, height=5.0)
```

