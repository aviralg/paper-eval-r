---
title: "Enrich the datasets with new columns."
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  base_dir: /var/lib/R/project-evalR
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res, units(res))
    }
  }
}))

knitr::opts_chunk$set(echo = TRUE,
                      fig.retina = 2,
                      fig.width = 10,
                      cache.lazy = FALSE,
                      time_it = TRUE)


now <- Sys.time() 
library(tidyverse)
library(stringr)
library(viridis)
library(vctrs)
library(DT)
library(fst)
library(fs)
library(parallel)


source("inc/paths.R")
source("inc/latextags.R")
source("inc/setup.R")
theme_set(theme_minimal())
create_tags(path(TAGS_DIR, "enrichDataset.tex"), prefix="", default=TRUE)

source("insights.R", local = knitr::knit_global())
source("preprocess.R", local = knitr::knit_global())
```

# Data

The analysis is being performed on a dataset read from file `r CALLS_FILE`.

```{r file-info, echo=FALSE}
file_info(CALLS_FILE)
```


```{r load-data, echo=FALSE}
corpus <- read_fst(CORPUS_DETAILS_FILE)

eval_calls_raw <-
    read_fst(CALLS_FILE) %>%
    as_tibble() %>%
    mutate(
      package=basename(dirname(dirname(file))),
      corpus="cran"
    ) %>%
    semi_join(corpus, by="package") # There might be more packages traced than what is in the corpus

eval_calls_kaggle_raw <- 
  read_fst(KAGGLE_CALLS_FILE) %>%
  as_tibble() %>% 
  mutate(
    package=basename(dirname(file)),
    corpus="kaggle"
  )

eval_calls_raw <- bind_rows(eval_calls_raw, eval_calls_kaggle_raw)
```

```{r deduplicate}
eval_calls <- eval_calls_raw %>% deduplicate()
```

```{r add_types}
eval_calls <- eval_calls %>% add_types()
```

```{r add_source}
eval_calls <- eval_calls %>% add_eval_source(eval_calls_raw) %>% add_eval_source_type()
```



```{r fake_srcref}
eval_calls <- eval_calls %>% add_fake_srcref()
```

```{r parse_args}
eval_calls <- eval_calls %>% add_parse_args()
```


```{r add_package}
# The package is already added when the files are loaded
#eval_calls <- eval_calls %>% add_package()
```

```{r shrink_to_corpus}
corpus_files <- read_lines(CORPUS_FILE)
eval_calls_corpus <- eval_calls %>% keep_only_corpus(corpus_files)

eval_calls_externals <- eval_calls %>% get_externals(corpus_files)
```


There are `r nrow(eval_calls)` unique rows. The file with dependent packages has `r nrow(eval_calls_externals)` rows and the one with only the packages in the corpus, `r nrow(eval_calls_corpus)`.

```{r separate_datasets}
eval_calls_core <- eval_calls_corpus %>% filter(eval_source_type == "core")
eval_calls_packages <- eval_calls_corpus %>% filter(eval_source_type == "package" )
eval_calls_kaggle <- eval_calls_corpus %>% filter(eval_source_type == "kaggle")
```

The core dataset has `r nrow(eval_calls_core)` unique calls, the packages dataset, `r nrow(eval_calls_packages)` and the kaggle one, `r nrow(eval_calls_kaggle)`.

```{r}
#eval_calls_raw <- eval_calls_raw %>% select(-ends_with("_type")) %>% left_join(eval_calls)

```

```{r}
# Used when using dataset 2 which has incorrect AST sizes.

#eval_calls_ast_size <- eval_calls_corpus %>% select(eval_call_srcref, caller_package, caller_function, eval_source_type, expr_resolved_nodes, nb_ev_calls)

#write_fst(eval_calls_ast_size, path(RUN_TRACE_DIR, "summarized-ast-size.fst"))
```


# Unknown evals

Some `eval` do not have srcref information attached and are not in *base*. It is often because they are located in a function that is created by another function.

```{r unknown_evals}

nb_eval_calls <- count(eval_calls, wt = nb_ev_calls)$n

undefined_evals <- eval_calls %>% filter(eval_source_type == "<undefined>")

nb_undefined <- undefined_evals %>% count(wt = nb_ev_calls)

nb_out_corpus <- undefined_evals %>% semi_join(eval_calls_externals) %>%
    count(wt = nb_ev_calls)

nb_different_call_expr <- undefined_evals %>% select(eval_call_expression) %>% n_distinct()

r("undefined evals", nb_undefined$n)
r("percent undefined eval", ratio(nb_undefined$n, nb_eval_calls))
r("undefined eval expressions", nb_different_call_expr)
r("undefined out of corpus", nb_out_corpus$n)
r("undefined out of coprus percent", ratio(nb_out_corpus$n, nb_undefined$n))
```


How many different undefined eval call sites do we have per package run?

```{r undefined_per_package}
undefined_per_package <- undefined_evals %>% group_by(package) %>% summarize(n = n_distinct(eval_call_expression)) 
known_packages <- setdiff(eval_calls$package, undefined_per_package$package) %>% as_tibble_col(column_name = "package")
known_packages <- known_packages %>% mutate(n = 0)

undefined_per_package <- bind_rows(undefined_per_package, known_packages) %>% arrange(desc(n))

```


# Known call sites per packages

```{r defined_call_sites}
call_sites_per_package <- eval_calls_corpus %>% 
    filter(eval_source_type == "package", eval_source %in% corpus_files) %>%
    group_by(eval_source) %>%
    summarize(n = n_distinct(eval_call_srcref)) 

known_packages <- setdiff(corpus_files, call_sites_per_package$eval_source) %>% as_tibble_col(column_name = "eval_source")

known_packages <- known_packages %>% mutate(n = 0)
    
call_sites_per_package <- bind_rows(call_sites_per_package, known_packages) %>%
  rename(package = eval_source) %>% 
  arrange(desc(n))

write_fst(call_sites_per_package, PACKAGE_EVALS_DYNAMIC_FILE)

```


```{r}
max_call_sites <- max(call_sites_per_package$n)
r("max call sites enrich", max_call_sites)

one_call_sites <- nrow(call_sites_per_package %>% filter(n == 1))
r("one call sites enrich", one_call_sites)

no_call_sites <- nrow(call_sites_per_package %>% filter(n == 0))
r("no call sites enrich", no_call_sites)
```


# Write

```{r write_back}
write_fst(undefined_per_package, EVALS_UNDEFINED_FILE)

write_fst(eval_calls, EVALS_RAW_FILE)

write_fst(eval_calls_core, EVALS_SUM_CORE_FILE)

write_fst(eval_calls_packages, EVALS_SUM_PKGS_FILE)

write_fst(eval_calls_kaggle, EVALS_SUM_KAGGLE_FILE)

write_fst(eval_calls_externals, EVALS_SUM_EXTERNALS_FILE)
```


```{r}
duration <- difftime(Sys.time(), now)
```


Notebook execution was `r duration` `r units(duration)`.

