---
title: "Enrich the datasets with new columns."
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  base_dir: /var/lib/R/project-evalR
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      fig.retina = 2,
                      fig.width = 10,
                      cache.lazy = FALSE)

library(tidyverse)
library(stringr)
library(viridis)
library(vctrs)
library(DT)
library(fst)
library(fs)
library(parallel)

source("inc/paths.R")
source("insights.R", local = knitr::knit_global())
source("preprocess.R", local = knitr::knit_global())
```

# Data

The analysis is being performed on a dataset read from file `r CALLS_FINAL_FILE`.

```{r file-info, echo=FALSE}
file_info(CALLS_FINAL_FILE)
```


```{r load-data, echo=FALSE}
eval_calls_raw <-
    read_fst(CALLS_FINAL_FILE) %>%
    as_tibble() %>%
    mutate(corpus = "cran")

eval_calls_kaggle_raw <- 
  read_fst(KAGGLE_CALLS_FINAL_FILE) %>%
  as_tibble() %>% 
  mutate(corpus = "kaggle")

eval_calls_raw <- bind_rows(eval_calls_raw, eval_calls_kaggle_raw)
```

```{r deduplicate}
eval_calls <- eval_calls_raw %>% deduplicate()
```

```{r add_types}
eval_calls <- eval_calls %>% add_types()
```

```{r add_source}
eval_calls <- eval_calls %>% add_eval_source() %>% add_eval_source_type()
```



```{r parse_args}
eval_calls <- eval_calls %>% add_parse_args()
```

```{r ast_size}
eval_calls <- eval_calls %>% add_ast_size()
```

```{r add_package}
eval_calls <- eval_calls %>% add_package()
```


```{r separate_datasets}
eval_calls_core <- eval_calls %>% filter(eval_source_type == "core")
eval_calls_packages <- eval_calls %>% filter(eval_source_type %in% c("package", "<undefined>") )
eval_calls_kaggle <- eval_calls %>% filter(eval_source_type == "kaggle")
```


```{r}
eval_calls_raw <- eval_calls_raw %>% select(-ends_with("_type")) %>% left_join(eval_calls)
```


```{r write_back}
write_fst(eval_calls, EVALS_RAW_FILE)

write_fst(eval_calls_core, EVALS_SUM_CORE_FILE)

write_fst(eval_calls_packages, EVALS_SUM_PKGS_FILE)

write_fst(eval_calls_kaggle, EVALS_SUM_KAGGLE_FILE)
```


