---
title: "Enrich the datasets with new columns."
output:
  rmdformats::readthedown:
        lightbox: true
        gallery: false
        df_print: paged
        toc_depth: 3
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  data_dirpath: "/var/lib/R/project-evalR/run/package-evals-traced-corpus.5/"
  data_filepath: "/var/lib/R/project-evalR/run/package-evals-traced-corpus.5/calls.fst"
  data_kagglepath: "/var/lib/R/project-evalR/kaggle-korpus/run/titanic/calls.fst"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "html") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      fig.retina = 2,
                      fig.width = 10,
                      cache.lazy = FALSE)

library(tidyverse)
library(stringr)
library(viridis)
library(vctrs)
library(DT)
library(fst)
library(fs)

source("insights.R", local = knitr::knit_global())

source("preprocess.R", local = knitr::knit_global())
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Data

The analysis is being performed on a dataset read from file `r params$data_filepath`.

```{r file-info, echo=FALSE}
file_info(params$data_filepath)
```


```{r load-data, echo=FALSE}
eval_calls_raw <-
    read_fst(params$data_filepath) %>%
    as_tibble() %>%
    mutate(corpus = "cran")

eval_calls_kaggle_raw <- 
  read_fst(params$data_kagglepath) %>%
  as_tibble() %>% 
  mutate(corpus = "kaggle")

eval_calls_raw <- bind_rows(eval_calls_raw, eval_calls_kaggle_raw)
```

```{r deduplicate}
eval_calls <- eval_calls_raw %>% deduplicate()
```

```{r add_types}
eval_calls <- eval_calls %>% add_types()
```

```{r add_source}
eval_calls <- eval_calls %>% add_eval_source() %>% add_eval_source_type()
```



```{r parse_args}
eval_calls <- eval_calls %>% add_parse_args()
```


```{r separate_datasets}
eval_calls_core <- eval_calls %>% filter(eval_source_type == "core")
eval_calls_packages <- eval_calls %>% filter(eval_source_type %in% c("package", "<undefined>") )
eval_calls_kaggle <- eval_calls %>% filter(eval_source_type == "kaggle")
```


```{r}
eval_calls_raw <- eval_calls_raw %>% select(-ends_with("_type")) %>% left_join(eval_calls)
```


```{r write_back}
write_fst(eval_calls, paste0(params$data_dirpath, "raws.fst"))

write_fst(eval_calls_core, paste0(params$data_dirpath, "summarized-core.fst"))

write_fst(eval_calls_packages, paste0(params$data_dirpath, "summarized-packages.fst"))

write_fst(eval_calls_kaggle, paste0(params$data_dirpath, "summarized-kaggle.fst"))
```


