---
title: "Empirical Evaluation of eval in R"
author: "Pierre Donat-Bouillud"
output:
  html_document:
        code_folding: hide
        gallery: false
        toc: true
        toc_depth: 3
        toc_float: true
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
params:
  base_dir: /var/lib/R/project-evalR
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      fig.retina = 2,
                      fig.width = 10,
                      cache.lazy = FALSE)

now <- Sys.time() 

library(tidyverse)
library(fst)

source("insights.R", local = knitr::knit_global())
source("preprocess.R", local = knitr::knit_global())
```

# Loading datafiles

```{r loading_fst}
eval_calls <- read_fst("/var/lib/R/project-evalR/run/package-evals-traced-test/calls.fst") %>%
  as_tibble() %>%
  deduplicate()

eval_calls <-   add_eval_source(eval_calls) %>% add_eval_source_type()
```

# Description of the data files

```{r packages}
nb_eval_calls <- count(eval_calls, wt = nb_ev_calls)

nb_call_sites <- nb_eval_call_sites(eval_calls)
```


There are `r count(eval_calls, wt=nb_ev_calls)` eval calls and `r eval_calls %>% select(eval_call_srcref) %>% n_distinct()` eval call sites in the dataset.

# Classification of environments

We distinguish between 5 main categories of `eval` calls with respect to their `envir` argument:

- `envir` is not provided explicitly (and thus is the default argument, which semantically belongs to the absolute category)
- `envir` in an eval call generated by Rcpp
- `envir` is a list or a data frame
- `envir` comes from an argument of the caller function
- `envir` is absolutely computed (with `parent.frame()` or equivalent)

## `envir` as default argument

```{r envir_default}
eval_calls_default <- eval_calls %>% filter(is.na(envir_expression))

nb_default <- count(eval_calls_default, wt = nb_ev_calls)
nb_default_sites <- nb_eval_call_sites(eval_calls_default)

eval_calls_explicit <- eval_calls %>% filter(!is.na(envir_expression))
```


# `envir` with Rcpp

```{r envir_rcpp}
eval_calls_rcpp <- eval_calls_explicit %>% filter(str_detect(expr_expression, "C\\+\\+Constructor|C\\+\\+Field|C\\+\\+OverloadedMethods")) 

nb_rcpp <- count(eval_calls_rcpp, wt = nb_ev_calls)
nb_rcpp_sites <- nb_eval_call_sites(eval_calls_rcpp)

eval_calls_explicit <- eval_calls_explicit %>% anti_join(eval_calls_rcpp)
```


##  `envir` as a list or data frame

```{r envir_list}
eval_calls_env_list <- eval_calls_explicit %>% filter(envir_type == "VECSXP")

nb_env_list <- count(eval_calls_env_list, wt = nb_ev_calls)
nb_env_list_sites <- nb_eval_call_sites(eval_calls_env_list)
```

## `envir` as an argument from the caller function

```{r envir_arg_caller}
eval_calls_arg_caller <- eval_calls_explicit %>% filter(!is.na(envir_from_arg))

nb_arg_caller <- count(eval_calls_arg_caller, wt = nb_ev_calls)
nb_arg_caller_sites <- nb_eval_call_sites(eval_calls_arg_caller)
```


Most of the eval calls directly use the argument, but some seem to modify it a lot:

```{r}
eval_calls_arg_caller %>% count(envir_from_arg, wt=nb_ev_calls, sort = TRUE) %>% knitr::kable()
```


In the current dataset, there are no examples of sandbox usage but we should see a distance of 1 in that case.


## `envir` absolutely computed

```{r envir_absolute}
eval_calls_absolute <- eval_calls_explicit %>% anti_join(eval_calls_env_list) %>% anti_join(eval_calls_arg_caller)

nb_absolute <- count(eval_calls_absolute, wt = nb_ev_calls)
nb_absolute_sites <- nb_eval_call_sites(eval_calls_absolute)
```

Let's do a sanity check: is the environment class the same in that category?

```{r}
eval_calls_absolute <- eval_calls_absolute  %>% add_fake_srcref() %>% group_by(eval_call_srcref) %>%  mutate(envir_distinct = n_distinct(environment_class)) 

eval_calls_absolute %>% ungroup() %>% count(envir_distinct, sort = TRUE)
```

We can also see a few examples:

```{r}
eval_calls_absolute %>% filter(envir_distinct == 2) %>% select(eval_call_expression, environment_class, envir_distinct)
```

## Summary of the categories

Total eval calls: `r nb_eval_calls`

Total eval call sites: `r nb_call_sites`

- Default: `r nb_default`, call sites: `r nb_default_sites`
- Rcpp: `r nb_rcpp`, call sites: `r nb_rcpp_sites`
- Argument of caller: `r nb_arg_caller`, call sites: `r nb_arg_caller_sites`
- Absolute: `r nb_absolute`, call sites: `r nb_absolute_sites`

```{r}
duration <- difftime(Sys.time(), now)
```

Notebook execution was `r duration` `r units(duration)`.
